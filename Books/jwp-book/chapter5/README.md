# 5장 웹 서버 리팩토링, 서블릿 컨테이너와 서블릿의 관계

요구사항에 대한 지식이 높아질수록 더 좋은 설계를 할 수 있으며, 더 깔끔한 코드를 구현할 수 있다.
이와 같이 설계는 한 번의 작업으로 끝내야 하는 것이 아니라 애플리케이션을 개발하고 배포해 운영하는 동안 끊임없이 진행해야 하는 것이 설계이다.
이와 같이 지속적인 설계와 구현을 잘 할 수 있는 방법이 지속적인 리팩토링이다.
리팩토링은 설계를 개선하기 위한 일련의 활동이다.

## 5.1 HTTP 웹 서버 리팩토링 실습

### 5.1.1 리팩토링할 부분 찾기

[리팩토링 : 코드 품질을 개선하는 객체지향 사고법](http://www.yes24.com/Product/Goods/7951038)(마틴 파울러 저/김지원 역, 한빛미디어/2012년): 리팩토링이 필요한 시접에 대한 정확한 기준을 제시하기보다 경험적으로 인간의 직관에 맡기고 있다.

### 5.1.2 리팩토링 1단계 힌트

#### 5.1.2.1 요청 데이터를 처리하는 로직을 별도의 클래스로 분리한다(HTTPRequest).

#### 5.1.2.2 응답 데이터를 처리하는 로직을 별도의 클래스로 분리한다(HttpResponse).

#### 5.1.2.3 다형성을 활용해 클라이언트 요청 URL에 대한 분기 처리를 제거한다.

클래스 다이어그램은 클래스 간의 관계를 쉽게 파악하기 위한 목적으로 사용하는 UML(Unified Modeling Language) 중의 하나이다.   
첫 번째는 인터페이스를 구현할 때(implements)와 상속(extends)의 경우 화살표 끝은 삼각형으로 같다.
다른 점은 인터페이스를 구현할 때는 점선으로 표시하고, 상속의 경우에는 실선으로 표시한다.   
두 번째는 클래스 간의 의존관계를 표시하는 부분이다.
클래스간의 의존관계는 열린 화살표를 사용한다.
단, 클래스의 의존관계가 클래스의 필드를 통해 연결되는 경우 실선, 메소드의 로컬 변수로 연결되는 경우 점선을 사용한다.
의존관계의 클래스를 해당 클래스의 인스턴스를 직접 생성하는 경우 `<<create>>`가 표시된다.

## 5.2 웹 서버 리팩토링 구현 및 설명

### 5.2.1 요청 데이터를 처리하는 로직을 별도의 클래스로 분리한다.

테스트 코드를 기반으로 개발할 경우, 첫번째 효과는 클래스에 버그가 있는지를 빨리 찾아 구현할 수 있다는 것이다.  
두번째 효과는 디버깅하기 쉽다는 것이다.
클래스에 대한 단위 테스트를 하는 것은 결과적으로 디버깅을 좀 더 쉽고 빠르게 할 수 있기 때문에 개발 생산성을 높여준다.  
세번째 효과는 테스트 코드가 있기 때문에 마음 놓고 리팩토링을 할 수 있다는 것이다.

private 메소드인데 로직의 복잡도가 높아 추가적인 테스트가 필요하다고 생각하는 메소드가 발생한다.
하지만 이 메소드만 별도로 분리해 테스트하기 힘들다.  
일반적으로 이를 해결하는 방법은 두 가지가 있다.  
첫째는 private 접근 제어자인 메소드를 default 접근 제어자로 수정하고 메소드 처리 결과를 반환하도록 수정해 테스트할 수 있다.  
둘째는 메소드 구현 로직을 새로운 클래스로 분리하는 방법이 있다.

### 5.2.2 응답 데이터를 처리하는 로직을 별도의 클래스로 분리한다.

### 5.2.3 다형성을 활용해 클라이언트 요청 URL에 대한 분기 처리를 제거한다.

OCP(개방폐쇄의 원칙, Open-Closed Principle) 원칙  
객체지향 설계 원칙 중 요구사항의 변경이나 추가사항이 발생하더라도, 기존 구성요소는 수정이 일어나지 말아야 하며, 기존 구성요소를 쉽게 확장해서 재사용할 수 있어야한다.

### 5.3 서블릿 컨테이너, 서블릿/JSP를 활용한 문제 해결

서블릿은 앞에서 구현한 웹 서버의 `Controller`, `HttpRequest`, `HttpResponse`를 추상화해 인터페이스로 정의해 놓은 표준이다.
즉, HTTP의 클라이언트 요청과 응답에 대한 표준을 정해 놓은 것을 서블릿이라 생각하면 된다.
서블릿 컨테이너는 이 서블릿 표준에 대한 구현을 담당하고 있으며 앞에서 구현한 웹 서버가 서블릿 컨테이너 역할과 같다고 생각하면 된다.

서블릿 컨테이너는 서버가 시작할 때 서블릿 인스턴스를 생성해, 요청 URL과 서블릿 인스턴스를 연결해 놓는다.
클라이언트에서 요청이 오면 요청 URL에 해당하는 서블릿을 찾아 서블릿에 모든 작업을 위임한다.

### 5.3.1 개발 환경 세팅 및 Hello World 출력

- https://youtu.be/jWVlAclnIXo : Embedded 톰캣 설정하는 방법
- https://youtu.be/xCXw8xmmWC4 : Hello World 출력하는 서블릿을 추가하고, 실행해 보는 과정
- https://youtu.be/OdCR6Y4_HAQ : relaunch plugin 설치하기

### 5.3.2 서블릿 컨테이너, 서블릿

서블릿 컨테이너의 중요한 역할 중의 하나는 서블릿 클래스의 인스턴스 생성, 요청 URL과 서블릿 인스턴스 매핑, 클라이언트 요청에 해당하는 서블릿을 찾은 후 서블릿에 작업을 위임하는 역할을 한다.
이외에도 서블릿 컨테이너는 서블릿과 관련한 초기화(init)와 소멸(destroy) 작업도 담당한다.

- 서블릿 컨테이너 시작
- 클래스패스에 있는 Servlet 인터페이스를 구현하는 서블릿 클래스를 찾음
- @WebServlet 설정을 통해 요청 URL과 서블릿 매핑
- 서블릿 인스턴스 생성
- init() 메소드를 호출해 초기화

서블릿 생성, 초기화, 서비스, 소멸 과정을 거치는 전체 과정을 서블릿의 생명주기(라이프사이클, life cycle)라 한다.
따라서 서블릿 컨테이너는 서블릿의 생명주기를 관리한다고 이야기한다.

## 5.4 추가 학습 자료

### 5.4.1 객체지향 설계와 개발

- [객체지향의 사실과 오해](http://www.yes24.com/Product/Goods/18249021)(조영호 저, 위키북스/2015): 객체지향의 이론적인 내용에 대해 학습할 수 있다.
  특히 객체를 설계할 때 각 객체의 역할, 책임, 협력이 중요한데 이와 관련해 초보 개발자도 이해할 수 있도록 예제를 통해 쉽게 풀어내고 있다.
- [개발자가 반드시 정복해야 할 객체지향과 디자인 패턴](http://www.yes24.com/Product/Goods/9179120)(최범균 저, 인투북스/2013): "객체지향의 사실과 오해" 책이 이론적인 부분을 다루고 있다면 이 책은 예제 코드를 통해 객체지향과 디자인패턴에 대해 다루고 있다.

### 5.4.2 서블릿 & JSP, 웹 애플리케이션 서버

- [Head First Servlet & JSP](http://www.yes24.com/Product/Goods/3301415)(케이시 시에라, 버트 베이츠, 브라얀 바샴 저/김종호 역, 한빛미디어/2009): 서블릿 컨테이너와 서블릿의 관계를 그림을 통해 잘 설명하고 있다.
  정말 오래된 서블릿 책이다. 오래된 버전을 다루고 있어 굳이 구매할 것을 추천하지 않는다.
  도서관에서 책을 빌린 후 "2장 웹 애플리케이션 아키텍처, 4장 서블릿이 되어보자"라도 읽어보면 서블릿 컨테이너와 서블릿 관계를 좀 더 명확하게 이해할 수 있다.
- [프로가 되기 위한 웹기술 입문](http://www.yes24.com/Product/Goods/6721651)(고모라 유스케 저/김정환 역, 위키북스/2012): 톰캣은 자바 진영에서 동적인 웹 애플리케이션을 지원하기 위한 서버이다.
  이와 같이 각 언어마다 동적인 웹 애플리케이션을 지원하는 서버를 웹 애플리케이션 서버(Web Application Server)라고 한다. 줄여서 와스(WAS)라고도 부른다.
  정적인 웹 자원을 서비스하고 부하 분산을 목적으로 하는 웹 서버가 존재한다. 대표적인 웹 서버는 아파치와 nginx가 있다.
  오랜기간 동안 아파치가 웹 서버의 강자였으나 최근에 nginx가 급부상하고 있다.
  웹 서버와 웹 애플리케이션 서버와의 관계에 대해 더 깊이 있게 학습하고 싶다면 책의 "5장 웹 애플리케이션의 구성 요소"를 읽어보기 바란다. 데이터베이스 서버와의 관계에 대해서도 학습할 수 있다. 

### 5.4.3 템플릿 엔진
